name: Validate Content

on:
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate YAML data files
        run: |
          pip install pyyaml
          python -c "
          import yaml, sys, glob
          errors = []
          for f in glob.glob('data/*.yaml'):
              try:
                  with open(f) as fh:
                      yaml.safe_load(fh)
                  print(f'OK: {f}')
              except yaml.YAMLError as e:
                  errors.append(f'{f}: {e}')
                  print(f'FAIL: {f}: {e}')
          if errors:
              sys.exit(1)
          "

      - name: Validate front matter in markdown files
        run: |
          python -c "
          import yaml, sys, glob, re

          errors = []
          for f in glob.glob('content/**/*.md', recursive=True):
              with open(f) as fh:
                  content = fh.read()
              match = re.match(r'^---\n(.*?)\n---', content, re.DOTALL)
              if not match:
                  if f.endswith('_index.md'):
                      continue
                  errors.append(f'{f}: no front matter found')
                  continue
              try:
                  fm = yaml.safe_load(match.group(1))
                  if not fm.get('title'):
                      errors.append(f'{f}: missing title')
                  print(f'OK: {f}')
              except yaml.YAMLError as e:
                  errors.append(f'{f}: {e}')
                  print(f'FAIL: {f}: {e}')

          for e in errors:
              print(f'ERROR: {e}', file=sys.stderr)
          if errors:
              sys.exit(1)
          "
